#!/usr/bin/env python



import os, sys, re

sys.path.insert(0, 'lib')

from prelude import *
from parser import *
# from debug_parser import *
from test_receiver import *

def main_(yaml=None):
  if yaml is None:
    yaml = file_read('-')

  if os.environ.get("DEBUG"):
    parser = DebugParser(TestReceiver())
  else:
    parser = Parser(TestReceiver())

  pass_ = True
  start = timer()

  try:
    parser.parse(yaml)
  except Exception as err:
    warn(err)
    pass_ = False

  time = timer(start)

  if re.match(r'\n.', yaml):
    n = "\n"
  else:
    n = ''
    yaml = re.sub(r'\n$', '\\n', yaml)

  if pass_:
    print(f"PASS - '{n}{yaml}'")
    print(parser.receiver.output())
    print("Parse time %.5fs" % time)
    return True
  else:
    print(f"FAIL - '{n}{yaml}'")
    print(parser.receiver.output())
    print("Parse time %.5fs" % time)
    return False

if main_(*sys.argv[1:]):
  sys.exit(0)
else:
  sys.exit(1)

# vim: sw=2:
